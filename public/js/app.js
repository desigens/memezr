!function(){function t(t,e,i,n,s,o){for(var l=e.split(" "),a="",h=0;h<l.length;h++){var d=a+l[h]+" ",c=t.measureText(d),g=c.width;g>s&&h>0?(t.fillText(a,i,n),a=l[h]+" ",n+=o):a=d}t.fillText(a,i,n)}var e=[{text:"чтобы сделать смешную картинку",top:190,size:20,textAlign:"left"},{text:"нам нужны были программы",top:428,size:30},{text:"мы рисовали их в MS PAINT, Карл",top:636,size:40,textAlign:"right"}];String.prototype.hashCode=function(){var t,e,i,n=0;if(0==this.length)return n;for(t=0,i=this.length;i>t;t++)e=this.charCodeAt(t),n=(n<<5)-n+e,n|=0;return n};var i=Backbone.Model.extend({defaults:{edit:!0,imageUrl:void 0,texts:[]},toggleEdit:function(){this.set("edit",!this.get("edit"))}}),n=Backbone.Model.extend({defaults:{text:"",left:0,top:0,color:"#fff",size:36,fontFamily:"Impact",textAlign:"center"},initialize:function(){this.on("change add",function(){this.save()})}}),s=Backbone.Collection.extend({model:n,localStorage:new Backbone.LocalStorage("KarlMeme"),initialize:function(){this.fetch(),0===this.length&&this.add(e)}}),o=Backbone.View.extend({events:{click:"toggleEdit",dblclick:"add","click .add":"add"},initialize:function(){this.canvas=document.createElement("canvas"),this.canvas.style.webkitFontSmoothing="antialiased",this.ctx=this.canvas.getContext("2d"),this.el.appendChild(this.canvas),this.image=new Image,this.image.onload=_.bind(this.render,this),this.image.src=this.model.get("imageUrl"),this.image.crossOrigin="anonymous";var t=new l({model:this.model,collection:this.model.get("texts")});this.el.appendChild(t.el);var e=document.createElement("i");e.className="add",e.innerHTML="+",this.el.appendChild(e),this.listenTo(this.model,"change:edit",this.render)},render:function(){this.canvas.width=this.image.width,this.canvas.height=this.image.height,this.el.style.width=this.image.width+"px",this.ctx.drawImage(this.image,0,0),this.model.get("edit")||this.model.get("texts").forEach(this.renderTexts,this),this.el.className=this.model.get("edit")?"edit":""},renderTexts:function(e){this.ctx.textBaseline="hanging",this.ctx.textBaseline="alphabetic",this.ctx.shadowBlur=20,this.ctx.shadowColor="black",this.ctx.font=e.get("size")+"px "+e.get("fontFamily"),this.ctx.fillStyle=e.get("color"),this.ctx.textAlign=e.get("textAlign");var i={left:10,center:this.image.width/2,right:this.image.width-10};t(this.ctx,e.get("text"),i[e.get("textAlign")],e.get("top"),this.image.width-10-10,e.get("size"))},toggleEdit:function(t){t.stopPropagation(),this.model.set("edit",!0)},add:function(t){this.model.get("texts").add({text:"hello",top:t.offsetY})}}),l=Backbone.View.extend({className:"bubbles",initialize:function(){this.listenTo(this.collection,"change",function(){}),this.listenTo(this.collection,"add",this.add),this.fill(),this.render()},fill:function(){var t=[];this.collection.forEach(function(e){var i=new a({model:e});t.push(i.el)}),this.$el.append(t)},add:function(t){var e=new a({model:t});this.$el.append(e.el)}}),a=Backbone.View.extend({className:"text",template:_.template($("#template").html(),null,{variable:"data"}),events:{keydown:"update",keyup:"update",click:"stopPropagation",dblclick:"stopPropagation","click .plus":"plus","click .minus":"minus","click .left":"left","click .center":"center","click .right":"right","click .remove":"destroy","change select":"fontFamily"},initialize:function(){_.bindAll(this,"update"),this.render(),this.$el.draggable({handle:".handler",axis:"y",containment:"parent",stop:_.bind(function(t,e){this.model.set("top",e.position.top)},this)}),this.listenTo(this.model,"change:textAlign change:size change:fontFamily",this.render),this.listenTo(this.model,"destroy",function(){this.remove()})},update:function(t){13===t.keyCode&&(document.execCommand("insertHTML",!1,""),t.preventDefault()),this.model.set("text",this.$el.find("div").text().trim())},stopPropagation:function(t){t.stopPropagation()},render:function(){this.$el.css({position:"absolute",top:this.model.get("top"),color:this.model.get("color"),fontSize:this.model.get("size"),fontFamily:this.model.get("fontFamily"),lineHeight:this.model.get("size")+"px",textAlign:this.model.get("textAlign")}),this.$el.html(this.template({text:this.model.get("text"),fontFamily:this.model.get("fontFamily"),textAlign:this.model.get("textAlign")}))},plus:function(){this.model.set("size",this.model.get("size")+1)},minus:function(){this.model.set("size",this.model.get("size")-1)},left:function(){this.model.set("textAlign","left")},center:function(){this.model.set("textAlign","center")},right:function(){this.model.set("textAlign","right")},fontFamily:function(t){this.model.set("fontFamily",$(t.target).find(":selected").text())},destroy:function(){this.model.destroy()}}),h=Backbone.View.extend({events:{click:"download"},initialize:function(t){this.canvas=t.canvas,this.button=this.$el.find("a")[0],this.listenTo(this.model,"change:edit",this.render),this.render()},render:function(){this.model.get("edit")?this.$el.hide():this.$el.show()},download:function(){var t=this.canvas.toDataURL("image/jpeg");this.button.href=t,this.button.download="carl"+JSON.stringify(this.model.attributes).hashCode()+".jpg"}}),d=Backbone.View.extend({events:{click:"done"},initialize:function(t){this.listenTo(this.model,"change:edit",this.render),this.render()},render:function(){this.model.get("edit")?this.$el.show():this.$el.hide()},done:function(){this.model.toggleEdit()}}),c=new i({imageUrl:"/images/karl.jpg",texts:new s}),g=new o({model:c,el:$("#container")}),r=new h({model:c,canvas:g.canvas,el:$("#download")}),m=new d({model:c,el:$("#done")});window.app={meme:c,view:g,download:r,done:m}}();